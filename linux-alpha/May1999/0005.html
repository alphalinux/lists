<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: Re: 2.2.7 Alpha Semaphore Bug</TITLE>
<META NAME="Author" CONTENT="Ivan Kokshaysky (ink@jurassic.park.msu.ru)">
<META NAME="Subject" CONTENT="Re: 2.2.7 Alpha Semaphore Bug">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>Re: 2.2.7 Alpha Semaphore Bug</H1>
<HR>
<P>
<!-- received="Fri May 07 19:42:14 1999" -->
<!-- isoreceived="19990508024214" -->
<!-- sent="Fri, 7 May 1999 20:47:29 +0400" -->
<!-- isosent="19990507164729" -->
<!-- name="Ivan Kokshaysky" -->
<!-- email="ink@jurassic.park.msu.ru" -->
<!-- subject="Re: 2.2.7 Alpha Semaphore Bug" -->
<!-- id="19990507204729.A346@jurassic.park.msu.ru" -->
<!-- inreplyto="199905061921.OAA00360@tipsy.zarniwoop.com" -->
<STRONG>Subject: </STRONG>Re: 2.2.7 Alpha Semaphore Bug<BR>
<STRONG>From: </STRONG>Ivan Kokshaysky (<EM>ink@jurassic.park.msu.ru</EM>)<BR>
<STRONG>Date: </STRONG>Fri May 07 1999 - 09:47:29 PDT
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#5">[ date ]</A>
<A HREF="index.html#5">[ thread ]</A>
<A HREF="subject.html#5">[ subject ]</A>
<A HREF="author.html#5">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0006.html">Richard Henderson: "Re: 2.2.7 Alpha Semaphore Bug"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0004.html">Kenneth Preslan: "2.2.7 Alpha Semaphore Bug"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0004.html">Kenneth Preslan: "2.2.7 Alpha Semaphore Bug"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0006.html">Richard Henderson: "Re: 2.2.7 Alpha Semaphore Bug"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0004.html">Ivan Kokshaysky: "Re: 2.2.7 Alpha Semaphore Bug"</A>
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
On Thu, May 06, 1999 at 02:21:06PM -0500, Kenneth Preslan wrote:
<BR>
<EM>&gt; Hi,
</EM><BR>
<EM>&gt; 
</EM><BR>
<EM>&gt; I'm having more problems with semaphores on a LX164 Alpha with 2.2.7.
</EM><BR>
<EM>&gt; 
</EM><BR>
[...]
<BR>
<EM>&gt; 
</EM><BR>
<EM>&gt; The problem is that the thread doesn't sleep when the counter of the semaphore
</EM><BR>
<EM>&gt; reaches zero.  The counter of the semaphore goes negative and the thread 
</EM><BR>
<EM>&gt; keeps going.  If the up() function was called on the semaphore 5 times, 
</EM><BR>
<EM>&gt; the thread eventually goes to sleep when the counter reaches -5.
</EM><BR>
<EM>&gt; 
</EM><BR>
[...]
<BR>
<P>*Sigh*. This time the problem is in up(). We should not increment
<BR>
waking if count &gt; 0 in wake_one_more().
<BR>
<P>Ivan.
<BR>
<P>--- linux/include/asm-alpha/semaphore-helper.h.orig	Thu Apr 15 16:42:32 1999
<BR>
+++ linux/include/asm-alpha/semaphore-helper.h	Fri May  7 19:59:46 1999
<BR>
@@ -18,7 +18,23 @@
<BR>
&nbsp;static inline void
<BR>
&nbsp;wake_one_more(struct semaphore * sem)
<BR>
&nbsp;{
<BR>
-	atomic_inc(&amp;sem-&gt;waking);
<BR>
+	long	tmp, tmp1;
<BR>
+
<BR>
+	/* if (count &lt;= 0) waking++ */
<BR>
+	/* An atomic conditional increment.  */
<BR>
+	__asm__ __volatile__(
<BR>
+		&quot;1:	ldq_l	%0,%2\n&quot;
<BR>
+		&quot;	addq	%0,%3,%1\n&quot;
<BR>
+		&quot;	addl	%0,0,%0\n&quot;
<BR>
+		&quot;	bgt	%0,2f\n&quot;
<BR>
+		&quot;	stq_c	%1,%2\n&quot;
<BR>
+		&quot;	beq	%1,3f\n&quot;
<BR>
+		&quot;2:\n&quot;
<BR>
+		&quot;.section .text2,\&quot;ax\&quot;\n&quot;
<BR>
+		&quot;3:	br	1b\n&quot;
<BR>
+		&quot;.previous&quot;
<BR>
+		: &quot;=&amp;r&quot;(tmp), &quot;=&amp;r&quot;(tmp1), &quot;=m&quot;(*sem)
<BR>
+		: &quot;r&quot;(0x0000000100000000));
<BR>
&nbsp;}
<BR>
&nbsp;
<BR>
&nbsp;static inline int
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0006.html">Richard Henderson: "Re: 2.2.7 Alpha Semaphore Bug"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0004.html">Kenneth Preslan: "2.2.7 Alpha Semaphore Bug"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0004.html">Kenneth Preslan: "2.2.7 Alpha Semaphore Bug"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0006.html">Richard Henderson: "Re: 2.2.7 Alpha Semaphore Bug"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0004.html">Ivan Kokshaysky: "Re: 2.2.7 Alpha Semaphore Bug"</A>
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Tue Jun 01 1999 - 09:56:34 PDT</EM>
</EM>
</SMALL>
</BODY>
</HTML>
