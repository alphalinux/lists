<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: [patch] missing icache flush on alpha</TITLE>
<META NAME="Author" CONTENT="Andrea Arcangeli (andrea@suse.de)">
<META NAME="Subject" CONTENT="[patch] missing icache flush on alpha">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>[patch] missing icache flush on alpha</H1>
<HR>
<P>
<!-- received="Sat Dec 11 16:41:51 1999" -->
<!-- isoreceived="19991212004151" -->
<!-- sent="Fri, 10 Dec 1999 02:23:05 +0100 (CET)" -->
<!-- isosent="19991210012305" -->
<!-- name="Andrea Arcangeli" -->
<!-- email="andrea@suse.de" -->
<!-- subject="[patch] missing icache flush on alpha" -->
<!-- id="Pine.LNX.4.10.9912100217440.12734-100000@alpha.random" -->
<STRONG>Subject: </STRONG>[patch] missing icache flush on alpha<BR>
<STRONG>From: </STRONG>Andrea Arcangeli (<EM>andrea@suse.de</EM>)<BR>
<STRONG>Date: </STRONG>Thu Dec 09 1999 - 17:23:05 PST
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#39">[ date ]</A>
<A HREF="index.html#39">[ thread ]</A>
<A HREF="subject.html#39">[ subject ]</A>
<A HREF="author.html#39">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0040.html">Andrea Arcangeli: "[patch] irq rewrite updated to 2.3.22pre2"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0038.html">Richard Henderson: "RLIM_INFINITY"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
The alpha has the icache not coherent with the dcache. So also in UP, if
<BR>
we write some code and we jump to it, we are going to execute the
<BR>
random data that was in memory before the write because the data written
<BR>
is still dirty in the dcache.
<BR>
<P>Even more potential is the SMP case: CPU1 can write the irq handler code
<BR>
to the CPU1-dcache and then can initialize a device after registering an
<BR>
irq. Then the other CPU0 (all irqs goes to CPU0 in 2.2.x you just know ;)
<BR>
can go to execute the irq handler before CPU0 had a chance to see the
<BR>
module code that is only present in the CPU1-dcache.
<BR>
<P>A module loading is exactly like self modifying code.
<BR>
<P>So I fixed this issue doing a proper imb() in UP and a sync-IPI imb() in
<BR>
SMP, before going to execute the module code (the imb() force the two
<BR>
caches to synchronize).
<BR>
<P>Patch against 2.2.14pre12 but it will almost sure apply cleanly also on
<BR>
the top of and all the others 2.2.x kernels:
<BR>
<P>diff -urN 2.2.14pre12/arch/alpha/kernel/smp.c 2.2.14pre12-imb/arch/alpha/kernel/smp.c
<BR>
--- 2.2.14pre12/arch/alpha/kernel/smp.c	Thu Dec  9 03:20:56 1999
<BR>
+++ 2.2.14pre12-imb/arch/alpha/kernel/smp.c	Thu Dec  9 14:11:58 1999
<BR>
@@ -839,6 +839,22 @@
<BR>
&nbsp;}
<BR>
&nbsp;
<BR>
&nbsp;static void
<BR>
+ipi_imb(void)
<BR>
+{
<BR>
+	imb();
<BR>
+}
<BR>
+
<BR>
+void
<BR>
+smp_imb(void)
<BR>
+{
<BR>
+	/* Must wait other processors to flush their icache before continue. */
<BR>
+	if (smp_call_function(ipi_imb, NULL, 1, 1))
<BR>
+		printk(KERN_CRIT &quot;smp_imb: timed out\n&quot;);
<BR>
+
<BR>
+	imb();
<BR>
+}
<BR>
+
<BR>
+static void
<BR>
&nbsp;ipi_flush_tlb_all(void *ignored)
<BR>
&nbsp;{
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tbia();
<BR>
diff -urN 2.2.14pre12/include/asm-alpha/pgtable.h 2.2.14pre12-imb/include/asm-alpha/pgtable.h
<BR>
--- 2.2.14pre12/include/asm-alpha/pgtable.h	Wed Dec  8 17:42:31 1999
<BR>
+++ 2.2.14pre12-imb/include/asm-alpha/pgtable.h	Thu Dec  9 14:11:46 1999
<BR>
@@ -17,13 +17,27 @@
<BR>
&nbsp;#include &lt;asm/spinlock.h&gt;	/* For the task lock */
<BR>
&nbsp;
<BR>
&nbsp;
<BR>
-/* Caches aren't brain-dead on the Alpha. */
<BR>
-#define flush_cache_all()			do { } while (0)
<BR>
+/* The icache is not coherent with the dcache on alpha, thus before
<BR>
+   running self modified code we must always run an imb().
<BR>
+   Actually flush_cache_all() is real overkill as it's recalled from
<BR>
+   vmalloc() before accessing pagetables and on the Alpha we are not required
<BR>
+   to flush the icache before doing that, but the semantic of flush_cache_all()
<BR>
+   requires us to flush _all_ the caches and so we must be correct here. It's
<BR>
+   instead vmalloc that should be changed to use a more finegrined cache
<BR>
+   flush operation (I suspect that also other archs doesn't need an icache
<BR>
+   flush while handling pagetables). OTOH vmalloc is not a performance critical
<BR>
+   path so after all we can live with it for now. */
<BR>
+#define flush_cache_all()			flush_icache_range(0, 0)
<BR>
&nbsp;#define flush_cache_mm(mm)			do { } while (0)
<BR>
&nbsp;#define flush_cache_range(mm, start, end)	do { } while (0)
<BR>
&nbsp;#define flush_cache_page(vma, vmaddr)		do { } while (0)
<BR>
&nbsp;#define flush_page_to_ram(page)			do { } while (0)
<BR>
-#define flush_icache_range(start, end)		do { } while (0)
<BR>
+#ifndef __SMP__
<BR>
+#define flush_icache_range(start, end)		imb()
<BR>
+#else
<BR>
+#define flush_icache_range(start, end)		smp_imb()
<BR>
+extern void smp_imb(void);
<BR>
+#endif
<BR>
&nbsp;
<BR>
&nbsp;/*
<BR>
&nbsp;&nbsp;* Use a few helper functions to hide the ugly broken ASN
<BR>
<P><P>The patch can be downloaded also from here:
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<A HREF="ftp://ftp.*.kernel.org/pub/linux/kernel/people/andrea/patches/v2.2/2.2.14pre12/alpha-imb-1.gz">ftp://ftp.*.kernel.org/pub/linux/kernel/people/andrea/patches/v2.2/2.2.14pre12/alpha-imb-1.gz</A>
<BR>
<P>The effect of this bug is that after loading a module the kernel could
<BR>
end executing random data.
<BR>
<P>Andrea
<BR>
<P>PS. Please read the comment I written in the patch before complaing me
<BR>
that I don't need to do icache flushes while reading pagetables. It's
<BR>
vmalloc that should be fixed according to the other archs. Check arm and
<BR>
sparc too.
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0040.html">Andrea Arcangeli: "[patch] irq rewrite updated to 2.3.22pre2"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0038.html">Richard Henderson: "RLIM_INFINITY"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Mon Jan 03 2000 - 11:15:13 PST</EM>
</EM>
</SMALL>
</BODY>
</HTML>
