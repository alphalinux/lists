<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: Re: 2.3.99-pre8 misc alpha patches</TITLE>
<META NAME="Author" CONTENT="Metod Kozelj (metod.kozelj@rzs-hm.si)">
<META NAME="Subject" CONTENT="Re: 2.3.99-pre8 misc alpha patches">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>Re: 2.3.99-pre8 misc alpha patches</H1>
<HR>
<P>
<!-- received="Fri May 26 21:47:24 2000" -->
<!-- isoreceived="20000527044724" -->
<!-- sent="Fri, 26 May 2000 10:58:51 +0200 (CEST)" -->
<!-- isosent="20000526085851" -->
<!-- name="Metod Kozelj" -->
<!-- email="metod.kozelj@rzs-hm.si" -->
<!-- subject="Re: 2.3.99-pre8 misc alpha patches" -->
<!-- id="Pine.HPP.3.96.1000526105512.29742A-200000@hmljhp.rzs-hm.si" -->
<!-- inreplyto="20000525173651.A3761@jurassic.park.msu.ru" -->
<STRONG>Subject: </STRONG>Re: 2.3.99-pre8 misc alpha patches<BR>
<STRONG>From: </STRONG>Metod Kozelj (<EM>metod.kozelj@rzs-hm.si</EM>)<BR>
<STRONG>Date: </STRONG>Fri May 26 2000 - 01:58:51 PDT
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#55">[ date ]</A>
<A HREF="index.html#55">[ thread ]</A>
<A HREF="subject.html#55">[ subject ]</A>
<A HREF="author.html#55">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0056.html">vickers@another.co.uk: "Earn $100,000 Per Year sending E-mail !!"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0054.html">Metod Kozelj: "Re: Need DLT support under Linux"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0051.html">Ivan Kokshaysky: "Re: 2.3.99-pre8 misc alpha patches"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0040.html">David Huggins-Daines: "Re: 2.3.99-pre8 misc alpha patches"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0051.html">Metod Kozelj: "Re: 2.3.99-pre8 misc alpha patches"</A>
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
Hello,
<BR>
<P>On Thu, 25 May 2000, Ivan Kokshaysky wrote:
<BR>
<P><EM>&gt; Heh. GAS from binutils-2.9.1 doesn't understand 'palXX' mnemonics.
</EM><BR>
<P>[ snip ]
<BR>
<P><EM>&gt; I forgot that hwrpb is checksum protected.
</EM><BR>
<P>[ snip ]
<BR>
<P>The fixes you sent worked great for me. Now I have PCA56 MVI set enabled
<BR>
and real frequency calculated, all in 2.2.15 kernel. Thanks a lot! I'm
<BR>
attaching the patch for 2.2.15 if somebody cares.
<BR>
<P>BTW, I have some SX164 systems that are built around EV56 processor. Is
<BR>
the patch harmless to those? (I don't want to test it since all systems in
<BR>
question are production machines).
<BR>
<P>Regards,
<BR>
&nbsp;&nbsp;Metod
<BR>
<P>Metod Kozelj
<BR>
<P>mailto:Metod.Kozelj@rzs-hm.si            /\  Ne posiljajte mi smeti ker grizem!
<BR>
<A HREF="http://www.rzs-hm.si/">http://www.rzs-hm.si/</A>                   /  \  Don't spam me for I bite!
<BR>
_______________________________________/    \__________________________________
<BR>
<P>---- perl -e 'print $i=pack(c5,(41*2),sqrt(7056),(unpack(c,H)-2),oct(115),10);'
<BR>
<P><P><P><P>
diff -urN linux-2.2.15-vanilla/arch/alpha/kernel/core_pyxis.c linux-2.2.15/arch/alpha/kernel/core_pyxis.c
<BR>
--- linux-2.2.15-vanilla/arch/alpha/kernel/core_pyxis.c	Thu May  4 02:16:30 2000
<BR>
+++ linux-2.2.15/arch/alpha/kernel/core_pyxis.c	Fri May 26 09:31:16 2000
<BR>
@@ -15,6 +15,7 @@
<BR>
&nbsp;
<BR>
&nbsp;#include &lt;asm/ptrace.h&gt;
<BR>
&nbsp;#include &lt;asm/system.h&gt;
<BR>
+#include &lt;asm/hwrpb.h&gt;
<BR>
&nbsp;#include &lt;asm/pci.h&gt;
<BR>
&nbsp;
<BR>
&nbsp;#define __EXTERN_INLINE inline
<BR>
@@ -522,6 +523,24 @@
<BR>
&nbsp;void __init
<BR>
&nbsp;pyxis_init_arch(unsigned long *mem_start, unsigned long *mem_end)
<BR>
&nbsp;{
<BR>
+	unsigned int cc0, cc1;
<BR>
+	unsigned long pyxis_cc;
<BR>
+
<BR>
+	/* On pyxis machines we can precisely calculate the
<BR>
+	   CPU clock frequency using pyxis real time counter.
<BR>
+	   Especially it's useful for SX164 with broken RTC.
<BR>
+	   Both CPU and chipset are driven by the single 16.666M
<BR>
+	   or 16.667M crystal oscillator. PYXIS_RT_COUNT clock is
<BR>
+	   66.66 MHz. -ink */
<BR>
+
<BR>
+	__asm__ __volatile__ (&quot;rpcc %0&quot; : &quot;=r&quot;(cc0));
<BR>
+	pyxis_cc = *(vulp)PYXIS_RT_COUNT;
<BR>
+	do { } while(*(vulp)PYXIS_RT_COUNT - pyxis_cc &lt; 4096);
<BR>
+	__asm__ __volatile__ (&quot;rpcc %0&quot; : &quot;=r&quot;(cc1));
<BR>
+	cc1 -= cc0;
<BR>
+	hwrpb-&gt;cycle_freq = ((cc1 &gt;&gt; 11) * 100000000UL) / 3;
<BR>
+	hwrpb_update_checksum(hwrpb);
<BR>
+
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pyxis_enable_errors();
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!pyxis_srm_window_setup())
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pyxis_native_window_setup();
<BR>
diff -urN linux-2.2.15-vanilla/arch/alpha/kernel/sys_sx164.c linux-2.2.15/arch/alpha/kernel/sys_sx164.c
<BR>
--- linux-2.2.15-vanilla/arch/alpha/kernel/sys_sx164.c	Mon Feb 22 04:06:36 1999
<BR>
+++ linux-2.2.15/arch/alpha/kernel/sys_sx164.c	Fri May 26 09:33:16 2000
<BR>
@@ -24,6 +24,7 @@
<BR>
&nbsp;#include &lt;asm/io.h&gt;
<BR>
&nbsp;#include &lt;asm/pgtable.h&gt;
<BR>
&nbsp;#include &lt;asm/core_pyxis.h&gt;
<BR>
+#include &lt;asm/hwrpb.h&gt;
<BR>
&nbsp;
<BR>
&nbsp;#include &quot;proto.h&quot;
<BR>
&nbsp;#include &quot;irq.h&quot;
<BR>
@@ -186,6 +187,35 @@
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SMC669_Init(0);
<BR>
&nbsp;}
<BR>
&nbsp;
<BR>
+static void __init
<BR>
+sx164_init_arch(unsigned long *mem_start, unsigned long *mem_end)
<BR>
+{
<BR>
+	/*
<BR>
+	 * OSF palcode v1.23 forgets to enable PCA56 Motion Video
<BR>
+	 * Instructions. Let's enable it.
<BR>
+	 * We have to check palcode revision because CSERVE interface
<BR>
+	 * is subject to change without notice. For example, it
<BR>
+	 * has been changed completely since v1.16 (found in MILO
<BR>
+	 * distribution). -ink
<BR>
+	 */
<BR>
+	struct percpu_struct *cpu = (struct percpu_struct*)
<BR>
+				((char*)hwrpb + hwrpb-&gt;processor_offset);
<BR>
+
<BR>
+	if (alpha_using_srm &amp;&amp; (cpu-&gt;pal_revision &amp; 0xffff) == 0x117) {
<BR>
+		__asm__ __volatile__(
<BR>
+		&quot;lda	$16,8($31)\n&quot;
<BR>
+		&quot;call_pal 9\n&quot;		/* Allow PALRES insns in kernel mode */
<BR>
+		&quot;.long	0x64000118\n&quot;	/* hw_mfpr $0,icsr */
<BR>
+		&quot;ldah	$16,(1&lt;&lt;(19-16))($31)\n&quot;
<BR>
+		&quot;or	$0,$16,$0\n&quot;	/* set MVE bit */
<BR>
+		&quot;.long  0x74000118\n&quot;	/* hw_mtpr $0,icsr */
<BR>
+		&quot;lda	$16,9($31)\n&quot;
<BR>
+		&quot;call_pal 9&quot;		/* Disable PALRES insns */
<BR>
+		: : : &quot;$0&quot;, &quot;$16&quot;);
<BR>
+		printk(&quot;PCA56 MVI set enabled\n&quot;);
<BR>
+	}
<BR>
+	pyxis_init_arch(mem_start, mem_end);
<BR>
+}
<BR>
&nbsp;
<BR>
&nbsp;/*
<BR>
&nbsp;&nbsp;* The System Vector
<BR>
@@ -206,7 +236,7 @@
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ack_irq:		generic_ack_irq,
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;device_interrupt:	sx164_device_interrupt,
<BR>
&nbsp;
<BR>
-	init_arch:		pyxis_init_arch,
<BR>
+	init_arch:		sx164_init_arch,
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;init_irq:		sx164_init_irq,
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;init_pit:		generic_init_pit,
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pci_fixup:		sx164_pci_fixup,
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0056.html">vickers@another.co.uk: "Earn $100,000 Per Year sending E-mail !!"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0054.html">Metod Kozelj: "Re: Need DLT support under Linux"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0051.html">Ivan Kokshaysky: "Re: 2.3.99-pre8 misc alpha patches"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0040.html">David Huggins-Daines: "Re: 2.3.99-pre8 misc alpha patches"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0051.html">Metod Kozelj: "Re: 2.3.99-pre8 misc alpha patches"</A>
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Thu Jun 01 2000 - 09:46:28 PDT</EM>
</EM>
</SMALL>
</BODY>
</HTML>
