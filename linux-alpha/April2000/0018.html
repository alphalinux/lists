<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: time_init() patch for Alpha.</TITLE>
<META NAME="Author" CONTENT="Larry Woodman (woodman@missioncriticallinux.com)">
<META NAME="Subject" CONTENT="time_init() patch for Alpha.">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>time_init() patch for Alpha.</H1>
<HR>
<P>
<!-- received="Fri Apr 28 23:17:20 2000" -->
<!-- isoreceived="20000429061720" -->
<!-- sent="Fri, 28 Apr 2000 16:36:32 -0400" -->
<!-- isosent="20000428203632" -->
<!-- name="Larry Woodman" -->
<!-- email="woodman@missioncriticallinux.com" -->
<!-- subject="time_init() patch for Alpha." -->
<!-- id="3909F650.90AF1340@missioncriticallinux.com" -->
<STRONG>Subject: </STRONG>time_init() patch for Alpha.<BR>
<STRONG>From: </STRONG>Larry Woodman (<EM>woodman@missioncriticallinux.com</EM>)<BR>
<STRONG>Date: </STRONG>Fri Apr 28 2000 - 13:36:32 PDT
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#18">[ date ]</A>
<A HREF="index.html#18">[ thread ]</A>
<A HREF="subject.html#18">[ subject ]</A>
<A HREF="author.html#18">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0019.html">Andrea Arcangeli: "Re: SMP gettimeofday patch"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0017.html">Larry Woodman: "Patch to prevent OOPS in __copy_user"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
The time_init() routine for Alpha should always trust the process
<BR>
cycle counter values over whats in the hwrpb-&gt;cycle_freq.  Without
<BR>
this the clock can be several minutes fast or slow per day.
<BR>
<P>This patch to arch/alpha/kernel/time.c seems to prevent the
<BR>
clock from running slower or faster than it should.
<BR>
<P>Larry Woodman
<BR>
<A HREF="http://www.missioncriticallinux.com">http://www.missioncriticallinux.com</A>
<BR>
<P><P><P><P><P>
--- arch/alpha/kernel/time.c.orig	Fri Apr 28 16:18:32 2000
<BR>
+++ arch/alpha/kernel/time.c	Fri Apr 28 16:25:05 2000
<BR>
@@ -230,12 +230,15 @@
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cycle_freq = hwrpb-&gt;cycle_freq;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;one_percent = cycle_freq / 100;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff = cycle_freq - est_cycle_freq;
<BR>
+
<BR>
+	/* Always trust the cycle counter measurement unless a kernel arg was passed in. */
<BR>
+	cycle_freq = est_cycle_freq;
<BR>
+
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (diff &lt; 0)
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diff = -diff;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (diff &gt; one_percent) {
<BR>
-		cycle_freq = est_cycle_freq;
<BR>
-		printk(&quot;HWRPB cycle frequency bogus.  Estimated %lu Hz\n&quot;,
<BR>
-		       cycle_freq);
<BR>
+		printk(&quot;HWRPB cycle frequency off by more than 1%: Reported %lu,  Calculated %lu Hz\n&quot;,
<BR>
+		       hwrpb-&gt;cycle_freq, cycle_freq);
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;est_cycle_freq = 0;
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0019.html">Andrea Arcangeli: "Re: SMP gettimeofday patch"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0017.html">Larry Woodman: "Patch to prevent OOPS in __copy_user"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Mon May 01 2000 - 18:42:06 PDT</EM>
</EM>
</SMALL>
</BODY>
</HTML>
