<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: Re: [BUG] (alpha) kernel thread panics due to</TITLE>
<META NAME="Author" CONTENT="Richard Henderson (rth@twiddle.net)">
<META NAME="Subject" CONTENT="Re: [BUG] (alpha) kernel thread panics due to stale PTBR settings in 2.3.47">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>Re: [BUG] (alpha) kernel thread panics due to stale PTBR settings in 2.3.47</H1>
<HR>
<P>
<!-- received="Wed Mar 08 17:22:56 2000" -->
<!-- isoreceived="20000309012256" -->
<!-- sent="Fri, 3 Mar 2000 18:32:05 -0800" -->
<!-- isosent="20000304023205" -->
<!-- name="Richard Henderson" -->
<!-- email="rth@twiddle.net" -->
<!-- subject="Re: [BUG] (alpha) kernel thread panics due to stale PTBR settings in 2.3.47" -->
<!-- id="20000303183205.A2045@twiddle.net" -->
<!-- inreplyto="38B6DC08.149FE822@mclinux.com" -->
<STRONG>Subject: </STRONG>Re: [BUG] (alpha) kernel thread panics due to stale PTBR settings in 2.3.47<BR>
<STRONG>From: </STRONG>Richard Henderson (<EM>rth@twiddle.net</EM>)<BR>
<STRONG>Date: </STRONG>Fri Mar 03 2000 - 18:32:05 PST
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#17">[ date ]</A>
<A HREF="index.html#17">[ thread ]</A>
<A HREF="subject.html#17">[ subject ]</A>
<A HREF="author.html#17">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0018.html">Der Herr Hofrat: "DP-264 ,BSD-Dislabels and SWAP-problems"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0016.html">Maciej W. Rozycki: "Re: new IRQ scalability changes in 2.3.48"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
On Fri, Feb 25, 2000 at 02:46:16PM -0500, Dave Anderson wrote:
<BR>
<EM>&gt; The problem was due to the disconnect between the active_mm pgd
</EM><BR>
<EM>&gt; value and what's actually stored in the kernel task's ptbr value --
</EM><BR>
<EM>&gt; which is what gets loaded into the PTBR register with each alpha
</EM><BR>
<EM>&gt; context switch.
</EM><BR>
<P>Yes, I can see the potential for a problem there.
<BR>
<P><EM>&gt;   I note that in 2.3.47, the problem looked to have been addressed by
</EM><BR>
<EM>&gt;   the addition of the enter_lazy_tlb() call in schedule():
</EM><BR>
<EM>&gt; 
</EM><BR>
<EM>&gt;         if (!mm) {
</EM><BR>
<EM>&gt;                 if (next-&gt;active_mm) BUG();
</EM><BR>
<EM>&gt;                 next-&gt;active_mm = oldmm;
</EM><BR>
<EM>&gt;                 atomic_inc(&amp;oldmm-&gt;mm_count);
</EM><BR>
<EM>&gt;   +++           enter_lazy_tlb(oldmm, next, this_cpu);
</EM><BR>
<EM>&gt;         }
</EM><BR>
<EM>&gt; 
</EM><BR>
<EM>&gt;   Unfortunately the alpha enter_lazy_tlb() doesn't do anything:
</EM><BR>
<P>I don't know if enter_lazy_tlb is appropriate.  It is used in
<BR>
two contexts: getting ready to swap context (eg that one) and
<BR>
not planning on swapping context any time soon (eg start_lazy_tlb).
<BR>
<P>But perhaps there's no issue at all with the later, since the
<BR>
&quot;host&quot; process can't really die without some sort of swpctx.
<BR>
<P>Try this.
<BR>
<P><P>r~
<BR>
<P><P>--- mmu_context.h.orig	Fri Mar  3 18:28:58 2000
<BR>
+++ mmu_context.h	Fri Mar  3 18:29:49 2000
<BR>
@@ -22,11 +22,6 @@
<BR>
&nbsp;#include &lt;asm/io.h&gt;
<BR>
&nbsp;#endif
<BR>
&nbsp;
<BR>
-static inline void
<BR>
-enter_lazy_tlb(struct mm_struct *mm, struct task_struct *tsk, unsigned cpu)
<BR>
-{
<BR>
-}
<BR>
-
<BR>
&nbsp;extern inline unsigned long
<BR>
&nbsp;__reload_thread(struct thread_struct *pcb)
<BR>
&nbsp;{
<BR>
@@ -221,6 +216,12 @@ extern inline void
<BR>
&nbsp;destroy_context(struct mm_struct *mm)
<BR>
&nbsp;{
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Nothing to do.  */
<BR>
+}
<BR>
+
<BR>
+static inline void
<BR>
+enter_lazy_tlb(struct mm_struct *mm, struct task_struct *tsk, unsigned cpu)
<BR>
+{
<BR>
+	tsk-&gt;thread.ptbr = ((unsigned long)mm-&gt;pgd - IDENT_ADDR) &gt;&gt; PAGE_SHIFT;
<BR>
&nbsp;}
<BR>
&nbsp;
<BR>
&nbsp;#ifdef __MMU_EXTERN_INLINE
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0018.html">Der Herr Hofrat: "DP-264 ,BSD-Dislabels and SWAP-problems"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0016.html">Maciej W. Rozycki: "Re: new IRQ scalability changes in 2.3.48"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Sat Apr 01 2000 - 04:15:03 PST</EM>
</EM>
</SMALL>
</BODY>
</HTML>
