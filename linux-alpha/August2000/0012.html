<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: [RFC] Setting the clock at boot time</TITLE>
<META NAME="Author" CONTENT=" ()">
<META NAME="Subject" CONTENT="[RFC] Setting the clock at boot time">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>[RFC] Setting the clock at boot time</H1>
<HR>
<P>
<!-- received="Tue Aug 22 18:58:49 2000" -->
<!-- isoreceived="20000823015849" -->
<!-- sent="Mon, 14 Aug 2000 02:07:34 +0200" -->
<!-- isosent="20000814000734" -->
<!-- subject="[RFC] Setting the clock at boot time" -->
<!-- id="20000814020734.B4743@lug-owl.de" -->
<STRONG>Subject: </STRONG>[RFC] Setting the clock at boot time<BR>
<EM></EM><BR>
<STRONG>Date: </STRONG>Sun Aug 13 2000 - 17:07:34 PDT
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#12">[ date ]</A>
<A HREF="index.html#12">[ thread ]</A>
<A HREF="subject.html#12">[ subject ]</A>
<A HREF="author.html#12">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0013.html">David S. Miller: "Vger lists have moved"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0011.html">: "Linux on DEC 300 - M500"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
Hi!
<BR>
<P>I discovered some files that were created in 2048(!) some time ago
<BR>
and now I've tracked down the problem.
<BR>
<P>./linux/drivers/char/rtc.o:
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The RTC driver is correct in detecting &quot;epoch = 1952&quot; for my
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;board (AXPpci33 aka NoName). The stored value for &quot;year&quot; is
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;48&quot; so rtc.o calculates 1952+48=2000. Fine.
<BR>
<P>./linux/arch/alpha/kernel/time.c:
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In time_init() the kernel's time is set by the value of
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the RTC's year field. However, 1900 is assumed to be the
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;correct epoch value as it is for normal PCs (originally,
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this time.c was copied from ia32 port AFAIthink):
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1900+48=1948. 1948 is smaller than 1970 so 100 is added: 2048.
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Not so fine...
<BR>
<P>Later in the boot process (after rtc.o is loaded) hwclock sets the
<BR>
kernel's time to the right value. However, some daemons were started
<BR>
before so some files have got timestamps in 2048;(
<BR>
<P>Solution 1:
<BR>
~~~~~~~~~~~
<BR>
Double the code from rtc.c which does the Right Thing just now. I think
<BR>
that this is the good thing to do. Alphas simply do have different
<BR>
epoches so we should take care for that... Unfortunately doubling
<BR>
the code may break some systems at their next boot if the person
<BR>
didn't use the rtc module befort to access RTC by hwclock: hwclock
<BR>
tries to work through rtc.o. If it is loaded - good. If not, hwclock
<BR>
uses ISA I/O. Not so good, as wrong values (wrt to the really correct
<BR>
epoch) may be stored. This results in wrong year values after correcting
<BR>
time.c.
<BR>
<P>Solution 2:
<BR>
~~~~~~~~~~~
<BR>
Keep everything as it is just right now. This is IMHO the Wrong Way
<BR>
as wrong values are stored. Quite a number of systems *are* running
<BR>
with wrong boot-up values. These wrong values are (normally) corrected
<BR>
during the userland boot up process (as it was for me). But some
<BR>
files are there with wrong time stamps (for me, they are in 2048).
<BR>
This is not so good.
<BR>
<P>I'd like you to comment on my (lengthy...) mail. Of course I've already
<BR>
a (very simple;) patch for Solution 1;)
<BR>
<P>MfG, JBG
<BR>
<P><PRE>
-- 
Fehler eingestehen, Größe zeigen: Nehmt die Rechtschreibreform zurück!!!
/* Jan-Benedict Glaw &lt;jbglaw@lug-owl.de&gt; -- +49-177-5601720 */
keyID=0x8399E1BB fingerprint=250D 3BCF 7127 0D8C A444 A961 1DBD 5E75 8399 E1BB
     &quot;insmod vi.o and there we go...&quot; (Alexander Viro on linux-kernel)
<P><P></PRE>
<HR>
<UL>
<LI>application/pgp-signature attachment: <A HREF="att-bin0GTgcFu">stored</A>
</UL>
<!-- attachment="att-bin0GTgcFu" -->
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0013.html">David S. Miller: "Vger lists have moved"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0011.html">: "Linux on DEC 300 - M500"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Fri Sep 01 2000 - 05:04:01 PDT</EM>
</EM>
</SMALL>
</BODY>
</HTML>
