<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: Re: 2.3.42 alpha updates</TITLE>
<META NAME="Author" CONTENT="Manfred Spraul (manfreds@colorfullife.com)">
<META NAME="Subject" CONTENT="Re: 2.3.42 alpha updates">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>Re: 2.3.42 alpha updates</H1>
<HR>
<P>
<!-- received="Sat Feb 05 23:39:10 2000" -->
<!-- isoreceived="20000206073910" -->
<!-- sent="Sat, 05 Feb 2000 23:00:49 +0100" -->
<!-- isosent="20000205220049" -->
<!-- name="Manfred Spraul" -->
<!-- email="manfreds@colorfullife.com" -->
<!-- subject="Re: 2.3.42 alpha updates" -->
<!-- id="389C9D91.D85032CB@colorfullife.com" -->
<!-- inreplyto="20000205120626.A17839@cygnus.com" -->
<STRONG>Subject: </STRONG>Re: 2.3.42 alpha updates<BR>
<STRONG>From: </STRONG>Manfred Spraul (<EM>manfreds@colorfullife.com</EM>)<BR>
<STRONG>Date: </STRONG>Sat Feb 05 2000 - 14:00:49 PST
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#102">[ date ]</A>
<A HREF="index.html#102">[ thread ]</A>
<A HREF="subject.html#102">[ subject ]</A>
<A HREF="author.html#102">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0103.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0101.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0101.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0103.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0101.html">Manfred Spraul: "Re: 2.3.42 alpha updates"</A>
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
Richard Henderson wrote:
<BR>
<EM>&gt; 
</EM><BR>
<EM>&gt; On Sat, Feb 05, 2000 at 11:57:34AM +0100, Manfred Spraul wrote:
</EM><BR>
<EM>&gt; &gt; It seems that Alpha is broken, because it relies on &quot;current-&gt;active_mm&quot;
</EM><BR>
<EM>&gt; &gt; to check if a flush is required.
</EM><BR>
<EM>&gt; 
</EM><BR>
<EM>&gt; Indeed it is broken.  What do you think of the following?
</EM><BR>
<EM>&gt; 
</EM><BR>
<EM>&gt; r~
</EM><BR>
<P>Hmm. I don't understand the current alpha code, so it's a bit difficult
<BR>
do verify your new code ;)
<BR>
<P>It seems that
<BR>
* Alpha doesn't use mm-&gt;cpu_vm_mask.
<BR>
* the tlb could contain entries from multiple processes, selected by the
<BR>
ASN.
<BR>
* the actual page table pointer is changed during switch_to(), not
<BR>
during switch_mm(). Is that an atomic operation, or could IPI's arrive
<BR>
between the page table pointer/ASN change and the &quot;current&quot; change?
<BR>
<P>If the change is atomic, then &quot;current-&gt;active_mm&quot; and the page table
<BR>
pointer are always in sync, so the i386 problem doesn't exist on Alpha.
<BR>
<P>But I don't understand what happens in the following scenario:
<BR>
<P>CPU0:		CPU1:
<BR>
thread mmA	page stealer(kswapd)
<BR>
<P>thread switch to mmB
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;changes a page from mmA
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flush_tlb_page(mmA,...)
<BR>
IPI!
<BR>
* notices that mmA is not loaded, no flush
<BR>
* mmA stored in .delayed_flush
<BR>
<P>thread switch back to mmA
<BR>
* prepare_to_switch() clears .delayed_flush
<BR>
<P>switch_mm(): ASN not yet wrapped, tlb reactivated.
<BR>
!! data access without tlb flush!!
<BR>
<P>Weird.
<BR>
I assumed that mm-&gt;cpu_vm_mask is intended for cpu's with ASN's: it
<BR>
should be a bit field, if the n'th bit is set, then the tlb of the n'th
<BR>
cpu could contain entries from that mm.
<BR>
<P>flush IPI's are sent to all cpu's in that bitfield, the problem is how
<BR>
to update that bitfield because you may not rely on &quot;current-&gt;active_mm&quot;
<BR>
from within the IPI handler.
<BR>
<P><PRE>
--
	Manfred
</PRE>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0103.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0101.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0101.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0103.html">Richard Henderson: "Re: 2.3.42 alpha updates"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0101.html">Manfred Spraul: "Re: 2.3.42 alpha updates"</A>
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Wed Mar 01 2000 - 06:26:28 PST</EM>
</EM>
</SMALL>
</BODY>
</HTML>
