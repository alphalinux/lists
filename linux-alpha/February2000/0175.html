<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Linux Alpha List: Re: new IRQ scalability changes in 2.3.48</TITLE>
<META NAME="Author" CONTENT="Linus Torvalds (torvalds@transmeta.com)">
<META NAME="Subject" CONTENT="Re: new IRQ scalability changes in 2.3.48">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>Re: new IRQ scalability changes in 2.3.48</H1>
<HR>
<P>
<!-- received="Wed Mar 01 07:11:55 2000" -->
<!-- isoreceived="20000301151155" -->
<!-- sent="Tue, 29 Feb 2000 12:04:56 -0800 (PST)" -->
<!-- isosent="20000229200456" -->
<!-- name="Linus Torvalds" -->
<!-- email="torvalds@transmeta.com" -->
<!-- subject="Re: new IRQ scalability changes in 2.3.48" -->
<!-- id="Pine.LNX.4.10.10002291156220.3750-100000@penguin.transmeta.com" -->
<!-- inreplyto="Pine.GSO.4.10.10002291838060.11534-100000@zeus.fh-brandenburg.de" -->
<STRONG>Subject: </STRONG>Re: new IRQ scalability changes in 2.3.48<BR>
<STRONG>From: </STRONG>Linus Torvalds (<EM>torvalds@transmeta.com</EM>)<BR>
<STRONG>Date: </STRONG>Tue Feb 29 2000 - 12:04:56 PST
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#175">[ date ]</A>
<A HREF="index.html#175">[ thread ]</A>
<A HREF="subject.html#175">[ subject ]</A>
<A HREF="author.html#175">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0176.html">Richard Henderson: "2.3.49-2 axp iommu update"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0174.html">Roman Zippel: "Re: new IRQ scalability changes in 2.3.48"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0174.html">Roman Zippel: "Re: new IRQ scalability changes in 2.3.48"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0178.html">Roman Zippel: "Re: new IRQ scalability changes in 2.3.48"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0174.html">Linus Torvalds: "Re: new IRQ scalability changes in 2.3.48"</A>
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
On Tue, 29 Feb 2000, Roman Zippel wrote:
<BR>
<EM>&gt; 
</EM><BR>
<EM>&gt; First, isn't the irq probing stuff ISA related? I don't know of any other
</EM><BR>
<EM>&gt; insanity that would need this.
</EM><BR>
<P>Well, you're probably never interested in using a PCMCIA card either, are
<BR>
you? 
<BR>
<P>Or a number of other buses which actually do use probing.
<BR>
<P><EM>&gt; - I think the spinlock in there isn't really necessary, if real state
</EM><BR>
<EM>&gt; changes are only happen from non-interrupt contexts. Everywhere else would
</EM><BR>
<EM>&gt; be a &quot;disable_irq(); spin_lock()&quot; sequence sufficient.
</EM><BR>
<P>&quot;disable_irq()&quot; is slow and requires the irq lock you want to get rid of
<BR>
for synchronization: on pretty much every single architecture out there
<BR>
interrupts are not &quot;synchronous&quot; wrt the core, so you cannot even disable
<BR>
an interrupt without having extra synchronization (which is exactly what
<BR>
the spinlock in do_IRQ gives you).
<BR>
<P>Many architectures do not have atomicity guarantees in SMP: you may end up
<BR>
getting the same interrupt twice on two CPU's. The spinlock handles that
<BR>
case too.
<BR>
<P><EM>&gt; - I doubt that all the status stuff is really necessary
</EM><BR>
<P>Pretty much all of it IS required. 
<BR>
<P><EM>&gt; - IRQ_REPLAY: Do interrupt handler require a real interrupt context or
</EM><BR>
<EM>&gt; isn't a faked context sufficient?
</EM><BR>
<P>They require that interrupts be on. 
<BR>
<P>Hint:
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CPU1					CPU2
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;disable_irq();
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- pending  due to synchronization --
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cli();
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enable_irq();
<BR>
<P>which you'll have on pretty much any architecture.
<BR>
<P><EM>&gt; - IRQ_WAITING: it's only used for int probing and could IMO be moved to a
</EM><BR>
<EM>&gt; special interrupt handler.
</EM><BR>
<P>And the cost of it is what? Zero.
<BR>
<P><EM>&gt; - IRQ_DISABLED: We could implement an optimistic scheme, where we replace
</EM><BR>
<EM>&gt; the action field with a dummy action, that keeps the interrupt disabled.
</EM><BR>
<EM>&gt; enable_irq()/disable_irq() would be very cheap then and we disable the
</EM><BR>
<EM>&gt; interrupt only when the really interrupt happens (and most of the time not
</EM><BR>
<EM>&gt; at all for short disable_irq()/enable_irq() sequences).
</EM><BR>
<P>Feel free to try it.  It was discussed, but it's not trivial to do
<BR>
correctly. You get the IRQ_PENDING problem even more clearly (ie it
<BR>
becomes a problem even with well-designed interrupt controllers).
<BR>
<P><EM>&gt; - IRQ_PENDING: If I interpret the comment there correctly, the check is
</EM><BR>
<EM>&gt; only necessary for faulty SMP hardware?
</EM><BR>
<P>It's only necessary for hardware that doesn't work the way we want it to
<BR>
work.
<BR>
<P>Which, sadly, is pretty much anything out there.
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Linus
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0176.html">Richard Henderson: "2.3.49-2 axp iommu update"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0174.html">Roman Zippel: "Re: new IRQ scalability changes in 2.3.48"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0174.html">Roman Zippel: "Re: new IRQ scalability changes in 2.3.48"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0178.html">Roman Zippel: "Re: new IRQ scalability changes in 2.3.48"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0174.html">Linus Torvalds: "Re: new IRQ scalability changes in 2.3.48"</A>
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Wed Mar 01 2000 - 06:26:28 PST</EM>
</EM>
</SMALL>
</BODY>
</HTML>
