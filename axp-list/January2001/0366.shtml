<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN"> 
     <HTML> 
     <HEAD> 
     <TITLE>Axp-List Archive</TITLE> 
     <LINK REV="made" HREF="mailto:mailto-address"> 
     <HEAD> 
     <BODY BGCOLOR="#DC9D33" TEXT="#000000" LINK="#DD0000" ALINK="#CC0000" VLINK="#CC0000">
		<CENTER>  <!--#exec cgi="/cgi-bin/banmat1.cgi"--></CENTER>

     <H1 ALIGN=CENTER>Axp-List Archive<BR> __kernel_execve() bug in 2.2.x</H1> 
	
<!-- received="Wed Jan 24 22:22:33 2001" -->
<!-- isoreceived="20010125062233" -->
<!-- sent="Wed, 24 Jan 2001 17:14:23 -0500" -->
<!-- isosent="20010124221423" -->
<!-- name="Soohoon Lee" -->
<!-- email="soohoon.lee@api-networks.com" -->
<!-- subject="__kernel_execve() bug in 2.2.x" -->
<!-- id="051DFF3BBA73D3119A5800A0C95BD021C0394D@barracuda.alpha-processor.com" -->
<STRONG>Subject: </STRONG>__kernel_execve() bug in 2.2.x<BR>
<STRONG>From: </STRONG>Soohoon Lee (<EM>soohoon.lee@api-networks.com</EM>)<BR>
<STRONG>Date: </STRONG>Wed Jan 24 14:14:23 2001
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.shtml#366">[ date ]</A>
<A HREF="index.shtml#366">[ thread ]</A>
<A HREF="subject.shtml#366">[ subject ]</A>
<A HREF="author.shtml#366">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0367.shtml">Todd Henderson: "Re: RH 7.0 install on XP1000's"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0365.shtml">James Fowler: "Re: 2.4 compile - 'help me I am stupid'"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
problem was race condition on free_filp.
<BR>
They have to acquire kernel lock before touch free_filp but
<BR>
in-kernel-use execve(), include/asm-alpha/unistd.h:execve() and 
<BR>
arch/alpha/kernel/process.c:__kernel_execve() doesn't do that.
<BR>
so following situation was possible.
<BR>
<P>CPU0
<BR>
0xfffffc0000351e44 get_empty_filp+0x44  (AR:0xfffffc007e043578)
<BR>
0xfffffc0000359308 open_dentry+0x68  (AR:0xfffffc007e043598)
<BR>
0xfffffc0000367e48 load_elf_binary+0x1a8  (AR:0xfffffc007e0435d8)
<BR>
0xfffffc000035a604 search_binary_handler+0x144  (AR:0xfffffc007e0437b8)
<BR>
0xfffffc000035a908 do_execve+0x1a8  (AR:0xfffffc007e0439c8)
<BR>
0xfffffc00003107f4 __kernel_execve+0x1c  (AR:0xfffffc007e043bd8)
<BR>
0xfffffc000033ced8 exec_usermodehelper+0x218  (AR:0xfffffc007e043be8)
<BR>
0xfffffc000033cf70 exec_modprobe+0x50  (AR:0xfffffc007e043d08)
<BR>
0xfffffc00003107c0 __kernel_thread+0x50  (AR:0xfffffc007e043d58)
<BR>
<P>CPU 1
<BR>
0xfffffc0000351e00 get_empty_filp  (AR:0xfffffc000025be38)
<BR>
0xfffffc000034fafc filp_open+0x3c  (AR:0xfffffc000025be38)
<BR>
0xfffffc000034fffc sys_open+0xbc  (AR:0xfffffc000025be68)
<BR>
Exception frame:
<BR>
0xfffffc0000310c50 entSys+0xa8  (AR:0xfffffc000025bf18)
<BR>
<P>Both cpus are accessing free_filp... In normal case, either CPU0 is waiting
<BR>
at __kernel_execve() or
<BR>
CPU1 is waiting at sys_open() for kernel lock.
<BR>
And It causes many different kind of panics and will cause other problems
<BR>
too, not only this free_filp case.
<BR>
So I put lock_kernel() and unlock_kernel() in __kernel_execve() and seems
<BR>
working fine.
<BR>
<P>And more, 2.4.0 is changed and execve() doesn't need to acquire kernel lock.
<BR>
So lock/unlock_kernel() in arch/alpha/kernel/process.c:sys_execve() need to
<BR>
be removed.
<BR>
<P>Attached is a patch for 2.2.18.
<BR>
<P>Soohoon.
<BR>
<P><P><HR>
<UL>
<LI>text/plain attachment: <A HREF="att-bin107V3eGA">__kernel_execve.txt</A>
</UL>
<!-- attachment="att-bin107V3eGA" -->
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0367.shtml">Todd Henderson: "Re: RH 7.0 install on XP1000's"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0365.shtml">James Fowler: "Re: 2.4 compile - 'help me I am stupid'"</A>
<!-- nextthread="start" -->
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR> 
     <P> 
     <SMALL> 
     <EM> 
     This archive was generated by  <A HREF="http://www.landfield.com/hypermail">hypermail version 2a22 </A> on Sat Mar  3 12:54:55 2001 PST <BR>
	Send any problems or questions about this archive to <A HREF="mailto:webmaster@alphalinux.org">webmaster@alphalinux.org</A>. 
     </EM> 
     </SMALL> 
     </BODY> 
     </HTML> 
