<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>axp-list: Re: instability</TITLE>
<META NAME="Author" CONTENT="Richard Henderson (rth@twiddle.net)">
<META NAME="Subject" CONTENT="Re: instability">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>Re: instability</H1>
<HR>
<P>
<!-- received="Sat Jun 19 20:41:35 1999" -->
<!-- isoreceived="19990620034135" -->
<!-- sent="Sat, 19 Jun 1999 12:58:43 -0700" -->
<!-- isosent="19990619195843" -->
<!-- name="Richard Henderson" -->
<!-- email="rth@twiddle.net" -->
<!-- subject="Re: instability" -->
<!-- id="19990619125843.A8357@twiddle.net" -->
<!-- inreplyto="376BCE96.8CACBF27@ma.ultranet.com" -->
<STRONG>Subject: </STRONG>Re: instability<BR>
<STRONG>From: </STRONG>Richard Henderson (<EM>rth@twiddle.net</EM>)<BR>
<STRONG>Date: </STRONG>Sat Jun 19 1999 - 12:58:43 PDT
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#406">[ date ]</A>
<A HREF="index.html#406">[ thread ]</A>
<A HREF="subject.html#406">[ subject ]</A>
<A HREF="author.html#406">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0407.html">Richard Henderson: "Re: axp patches for 2.2.9"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0405.html">Leslie Donaldson: "Milo and Raid level1"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0426.html">Darren Breeze: "RE: instability (patch)"</A>
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
On Sat, Jun 19, 1999 at 01:08:38PM -0400, Jay Estabrook wrote:
<BR>
<EM>&gt; Any progress on the ASN/TLB stuff we were discussing?
</EM><BR>
<P>Yes.  I sent a message to axp-list in the wee hours Friday morning, but
<BR>
sent it from the wrong account and it bounced.
<BR>
<P>It's because we made no effort to validate p-&gt;tss.asn, only p-&gt;mm-&gt;context.
<BR>
This is a mistake whenever there exist multiple processes that share VM, as
<BR>
with threads or vfork.
<BR>
<P>Consider two processes A and B sharing a VM.  Allow that both have slept
<BR>
across the asn rollover.  Process A gets scheduled first, notes that
<BR>
A-&gt;mm-&gt;context is out of date, allocates a new one, and updates A-&gt;tss.asn
<BR>
and A-&gt;mm-&gt;context.  Process B gets scheduled, notes that B-&gt;mm-&gt;context
<BR>
is up to date, and proceeds to use an out of date asn, causing all sorts
<BR>
of havok.
<BR>
<P>A similar problem occurs on SMP when a pair of threads migrates to a
<BR>
different processor.
<BR>
<P>I've played around with a couple of variations on a patch.  Attached
<BR>
is my favourite so far.
<BR>
<P>A variant that I'm considering relies on the fact that the PALcode only
<BR>
reads tss.asn, and that the hardware ignores bits outside the supported
<BR>
range.  As it is, we have to also keep a shadow field in tss with the
<BR>
full context.
<BR>
<P>One problem that variant is that it narrows the context from 64 bits
<BR>
to 32 bits, due to the field width of tss.asn.  Which means there are
<BR>
now only 19 instead of 51 bits of serial number, which means that the
<BR>
possibility of a process sleeping through serial number rollover and
<BR>
running with an invalid asn is real. 
<BR>
<P>I'm half convinced that the cure (detecting serial number rollover and
<BR>
walking the process list to reset everyone's context) is worse than
<BR>
just keeping a second field in the tss.
<BR>
<P>(Linus, this is different from the patch I sent Friday -- that one
<BR>
had a silly thinko that allocated asn contexts more often than needed,
<BR>
and in the SMP case where two threads run on different processors 
<BR>
would allocate new contexts every time they are scheduled.)
<BR>
<P>In addition to solving this problem, the patch also fixes EV4, which
<BR>
was broken when the tbia was removed from alpha_switch_to.  Also, 
<BR>
the SMP last_asn array is dispersed into per-cpu local data to avoid
<BR>
fighting over cache lines.  Also, __reload_tss is cleaned up to 
<BR>
properly use virt_to_phys instead of doing some silly masking thing.
<BR>
<P><P>r~
<BR>
<P><P><HR>
<UL>
<LI>application/x-gunzip attachment: <A HREF="att-bin1a07709">stored</A>
</UL>
<!-- attachment="att-bin1a07709" -->
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0407.html">Richard Henderson: "Re: axp patches for 2.2.9"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0405.html">Leslie Donaldson: "Milo and Raid level1"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0426.html">Darren Breeze: "RE: instability (patch)"</A>
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.www.fts.frontec.se/~dast/hypermail/">hypermail 2a22</A> 
: <EM>Wed Jun 30 1999 - 19:27:26 PDT</EM>
</EM>
</SMALL>
</BODY>
</HTML>
