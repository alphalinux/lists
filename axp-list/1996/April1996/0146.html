<!-- received="Wed Apr 10 20:42:46 1996 " -->
<!-- sent="Wed, 10 Apr 1996 20:42:46 -0700" -->
<!-- name="David Mosberger-Tang" -->
<!-- email="davidm@cs.arizona.edu" -->
<!-- subject="Re: More on f2c..." -->
<!-- id="199604110342.UAA10003@koppel.cs.arizona.edu" -->
<!-- inreplyto="More on f2c..." -->
<HTML><HEAD><META NAME="htdig-email" CONTENT="webmaster@redhat.com"><TITLE>Re: More on f2c...</TITLE>
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#ececec"  LINK="#3333cc" VLINK="#666666"><h2>Re: More on f2c...</h2>

<b>David Mosberger-Tang</b> (<a href="mailto:davidm@cs.arizona.edu"><i>davidm@cs.arizona.edu</i></a>)<br>
<i>Wed, 10 Apr 1996 20:42:46 -0700</i>
<p>
<ul>
<li> <b>Messages sorted by:</b> <a href="date.html#146">[ date ]</a><a href="index.html#146">[ thread ]</a><a href="subject.html#146">[ subject ]</a><a href="author.html#146">[ author ]</a>
<!-- next="start" -->
<li> <b>Next message:</b> <a href="0147.html">Martin Ostermann: "Ethernet 3C59x used by anybody?"</a>
<li> <b>Previous message:</b> <a href="0145.html">Erik Troan: "Re: More on f2c..."</a>
<li> <b>Maybe in reply to:</b> <a href="0144.html">Jim Paradis: "More on f2c..."</a>
<!-- nextthread="start" -->
<!-- reply="end" -->
</ul>
<!-- body="start" -->
<i> &gt; Well, that didn't do it.  After rebuilding f2c with the -ieee flag, I</i><br>
<i> &gt; still got "floating exception during constant evaluation" when I</i><br>
<i> &gt; tried to build scilab-2.2</i><br>
<p>
<i> &gt; One thing to note: the "constant evaluation" bit is a red herring; f2c</i><br>
<i> &gt; prints the same message regardless of what caused the floating exception.</i><br>
<p>
<i> &gt; I'm looking into it...</i><br>
<p>
There was a problem with gcc -mieee when doing float (as opposed to<br>
double) arithmetic.  It's fixed in the latest gcc snapshot, but it<br>
will require an updated gas as well (the fixed gcc generates the cvtst<br>
instruction which the old gas didn't know about).  I don't remember<br>
exactly what the problem was, but it basically boiled down to gcc not<br>
being able to convert non-finite float constants into doubles.<br>
<p>
Some more caveats:<br>
<p>
        - The quality of the code generated by gcc -mieee is abysmal;<br>
        I can say it because it's my fault.  I'm not really a gcc<br>
        hacker (nor a floating point guy, for that matter), so I just put<br>
        the minimal support into gcc to get non-finite arithmetic going.  If<br>
        you want to turn a great day into a really bad one, just do<br>
        gcc -mieee -O2 -S somefpcode.c and look at its output---but don't<br>
        blame me if you end up with stomach cramps and a sleepless night...<br>
	The fundamental problem is that the current gcc's register allocator<br>
	knows nothing about the special constraints when generating code<br>
	for -mieee.  This has the effect that many more trap barriers are<br>
	generated than is strictly necessary.  To make matters worse, gcc<br>
	ends up moving fp values needlessly back and forth between registers.<br>
	I think the situation could be improved a lot by adding a strategy<br>
	to the register allocator that would minimize reuse of source<br>
	operands within a basic block when -mieee is in effect.<br>
<p>
        - Rounding of denormalized single-precision numbers is known<br>
	to be incorrect. It's not all that bad, but it's not according<br>
	to IEEE specs, I'm being told.  The only grace is that DEC Unix<br>
	doesn't seem get it right either.<br>
<p>
	- The kernel emulation code is there and as far as I tested it,<br>
	appears to work quite well.  I believe to have tested the<br>
	generation and handling of QNaN, NaN, +Inf, and -Inf values<br>
	exhaustively, but not being an fp guy, I haven't really done<br>
	anything heavy duty otherwise.  I did run Stephen Monnier's<br>
	fp torture test and from what I saw, there wasn't anything<br>
	obvious wrong (except for the single prec denormal rounding<br>
	problem mentioned above).  But then, I don't really claim I<br>
	understand all it tried to do...<br>
<p>
	- The math libraries and even some of the libc code would have<br>
	to be recompiled with -mieee as well.  In essence, anything<br>
	that uses double or float arithmetic operations would need<br>
	to be recompiled.  The easiest thing would probably be to<br>
	provide two versions of each library, one with and one without<br>
	-mieee support.  For a better (and more complicated solution),<br>
	see DEC Unix's use of the .eflag directive in assembly files.<br>
	If I understand it correctly, DEC Unix marks object files that<br>
	are compiled with -mieee and if such an object file has an<br>
	undefined reference to a function for which there is a -mieee<br>
	version available, it'll link it against that one.  The current<br>
	gas simply ignores the .eflag directive.  I don't know how difficult<br>
	it would be to add the DEC Unix linker's clever linking strategy into<br>
	the GNU linker.<br>
<p>
So now that you all know what's wrong with the current ieee support, I<br>
hope some of you may tackle one or two of the existing<br>
limitations... :-)<br>
<p>
	--david<br>
<!-- body="end" -->
<p>
<ul>
<!-- next="start" -->
<li> <b>Next message:</b> <a href="0147.html">Martin Ostermann: "Ethernet 3C59x used by anybody?"</a>
<li> <b>Previous message:</b> <a href="0145.html">Erik Troan: "Re: More on f2c..."</a>
<li> <b>Maybe in reply to:</b> <a href="0144.html">Jim Paradis: "More on f2c..."</a>
<!-- nextthread="start" -->
<!-- reply="end" -->
</ul>
<br clear=all>
<hr>
<center>
<a href="mailto:webmaster@redhat.com"   target="">Feedback</a> | 
<a href="http://www.redhat.com/products/"   target="">Store</a> | 
<a href="http://www.redhat.com/news/"   target="">News</a> | 
<a href="http://www.redhat.com/support/"   target="">Support</a> | 
<a href="http://www.redhat.com/support/docs/errata.html"   target="">Product Errata</a> | 
<a href="http://www.redhat.com/redhat/"   target="">About Us</a> | 
<a href="http://www.redhat.com/linux-info/"   target="">Linux Info</a> | 
<a href="http://www.redhat.com/search/"   target="">Search</a> | 
<a href="http://www.redhat.com/jumplist.phtml"   target="">JumpWords</a>
<br>
<a href="http://www.redhat.com/cgi-bin/frames.phtml?fr=n"  _top target="_top">No Frames</a> | 
<a href="http://www.redhat.com/cgi-bin/frames.phtml?fr=y"  _top target="_top">Show Frames</a>
</center>
<p align=center>
Copyright &copy; 1995-1997 Red Hat Software. <a href="http://www.redhat.com/redhat/website.html#legal"   target="">Legal notices</a>
</p>
</BODY></HTML>
