<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN"> 
     <HTML> 
     <HEAD> 
     <TITLE>Axp-List Archive</TITLE> 
     <LINK REV="made" HREF="mailto:mailto-address"> 
     <HEAD> 
     <BODY BGCOLOR="#DC9D33" TEXT="#000000" LINK="#DD0000" ALINK="#CC0000" VLINK="#CC0000">
		<CENTER>  <!--#exec cgi="/cgi-bin/banmat1.cgi"--></CENTER>

     <H1 ALIGN=CENTER>Axp-List Archive<BR> Re: More fun with spinlocks</H1> 
	
<!-- received="Thu Apr 19 07:36:18 2001" -->
<!-- isoreceived="20010419143618" -->
<!-- sent="Thu, 19 Apr 2001 01:30:40 -0400" -->
<!-- isosent="20010419053040" -->
<!-- name="Greg Lindahl" -->
<!-- email="lindahl@conservativecomputer.com" -->
<!-- subject="Re: More fun with spinlocks" -->
<!-- id="20010419013040.A2454@wumpus.int.den.wayport.net" -->
<!-- inreplyto="More fun with spinlocks" -->
<STRONG>Subject: </STRONG>Re: More fun with spinlocks<BR>
<STRONG>From: </STRONG>Greg Lindahl (<EM>lindahl@conservativecomputer.com</EM>)<BR>
<STRONG>Date: </STRONG>Wed Apr 18 22:30:40 2001
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.shtml#426">[ date ]</A>
<A HREF="index.shtml#426">[ thread ]</A>
<A HREF="subject.shtml#426">[ subject ]</A>
<A HREF="author.shtml#426">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0427.shtml">Ionut Georgescu: "g77 issues"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0425.shtml">Greg Lindahl: "Re: More fun with spinlocks"</A>
<LI><STRONG>Maybe in reply to:</STRONG> <A HREF="0369.shtml">Greg Lindahl: "More fun with spinlocks"</A>
<!-- nextthread="start" -->
<LI><STRONG>Maybe reply:</STRONG> <A HREF="0369.shtml">Greg Lindahl: "Re: More fun with spinlocks"</A>
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
I got a request to post the exact patch from trond. This was tested
<BR>
by Craig Tierney and apparently resolved the problem.
<BR>
<P>----------
<BR>
<P>Urgh. I see what's going wrong: it's the mod_timer() thing in
<BR>
xprt_add_tcp_timer() that's waiting on the bottom half to finish. Odd
<BR>
that's never surfaced before.
<BR>
<P>Does the following patch fix it?
<BR>
<P>Cheers,
<BR>
&nbsp;&nbsp;Trond
<BR>
<P>--- net/sunrpc/xprt.c.orig	Sun Mar 25 18:37:42 2001
<BR>
+++ net/sunrpc/xprt.c	Wed Apr 18 11:10:21 2001
<BR>
@@ -1145,9 +1145,11 @@
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long	oldflags;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spin_lock_irqsave(&amp;xprt_sock_lock, oldflags);
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xprt-&gt;snd_task = NULL;
<BR>
-		if (!rpc_wake_up_next(&amp;xprt-&gt;sending) &amp;&amp; xprt-&gt;stream)
<BR>
+		if (!rpc_wake_up_next(&amp;xprt-&gt;sending) &amp;&amp; xprt-&gt;stream) {
<BR>
+			spin_unlock_irqrestore(&amp;xprt_sock_lock, oldflags);
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xprt_add_tcp_timer(xprt, RPCXPRT_TIMEOUT);
<BR>
-		spin_unlock_irqrestore(&amp;xprt_sock_lock, oldflags);
<BR>
+		} else
<BR>
+			spin_unlock_irqrestore(&amp;xprt_sock_lock, oldflags);
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
<BR>
&nbsp;}
<BR>
<P><P><P><P>_______________________________________________
<BR>
Axp-list mailing list
<BR>
Axp-list@redhat.com
<BR>
https://listman.redhat.com/mailman/listinfo/axp-list
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0427.shtml">Ionut Georgescu: "g77 issues"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0425.shtml">Greg Lindahl: "Re: More fun with spinlocks"</A>
<LI><STRONG>Maybe in reply to:</STRONG> <A HREF="0369.shtml">Greg Lindahl: "More fun with spinlocks"</A>
<!-- nextthread="start" -->
<LI><STRONG>Maybe reply:</STRONG> <A HREF="0369.shtml">Greg Lindahl: "Re: More fun with spinlocks"</A>
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR> 
     <P> 
     <SMALL> 
     <EM> 
     This archive was generated by  <A HREF="http://www.landfield.com/hypermail">hypermail version 2a22 </A> on Sat May  5 06:18:13 2001 PDT <BR>
	Send any problems or questions about this archive to <A HREF="mailto:webmaster@alphalinux.org">webmaster@alphalinux.org</A>. 
     </EM> 
     </SMALL> 
     </BODY> 
     </HTML> 
