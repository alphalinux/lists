<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>axp-list: Re: LX164 and rpcc</TITLE>
<META NAME="Author" CONTENT="Richard Henderson (rth@cygnus.com)">
<META NAME="Subject" CONTENT="Re: LX164 and rpcc">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>Re: LX164 and rpcc</H1>
<HR>
<P>
<!-- received="Fri Dec 18 17:06:37 1998 PST" -->
<!-- sent="Fri, 18 Dec 1998 08:53:48 -0800" -->
<!-- name="Richard Henderson" -->
<!-- email="rth@cygnus.com" -->
<!-- subject="Re: LX164 and rpcc" -->
<!-- id="19981218085348.B15474@dot.cygnus.com" -->
<!-- inreplyto="Pine.LNX.3.96.981218145230.21851A-100000@peak3.cs.hut.fi" -->
<STRONG>Richard Henderson</STRONG> (<A HREF="mailto:rth@cygnus.com?subject=Re:%20LX164%20and%20rpcc"><EM>rth@cygnus.com</EM></A>)<BR>
<EM>Fri, 18 Dec 1998 08:53:48 -0800</EM>
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#811">[ date ]</A>
<A HREF="index.html#811">[ thread ]</A>
<A HREF="subject.html#811">[ subject ]</A>
<A HREF="author.html#811">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0812.html">Matt Wagner: "RE: SCSI Tape Drives"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0810.html">Chris Price: "Re: SCSI Tape Drives"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0802.html">Joachim Wesner: "Re: SCSI Tape Drives"</A>
<!-- nextthread="start" -->
</UL>
<HR>
<!-- body="start" -->
<P>
On Fri, Dec 18, 1998 at 03:02:05PM +0200, Hannu Mallat wrote:
<BR>
<EM>&gt; Any kernel hackers out there? What's going on? Again, the sample program
</EM><BR>
<EM>&gt; works fine on the OSF/1 machine I have access to. 
</EM><BR>
<P>I think there's a bug in the PALcode, in that it doesn't 
<BR>
properly handle the CC when swapping to the same context,
<BR>
which we do when we need to change page table mappings.
<BR>
<P>If you're adventurous, you might try something like this:
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stq_p   t10, PCB_Q_USP(v0)      // Store user stack pointer
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addl    p5, p7, p7              // Set new time
<BR>
<P>+	cmpeq	v0, a0, t10		// Are old and new contexts equal?
<BR>
+	cmoveq	t10, p7, p5		// If not, set new time.
<BR>
<P>-       stl_p   p7, PCB_L_PCC(v0)       // Store new time
<BR>
+       stl_p   p5, PCB_L_PCC(v0)       // Store new time
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bis     zero, 1, t10            // Get a '1'
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sll     t10, ICSR_V_FPE, t10    // Shift '1' into ICSR&lt;FPE&gt; position
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mfpr    p7, icsr                // Get current ICSR value
<BR>
<P><P>Grr, actually, that won't work as-is cause we've run out of room
<BR>
in the SwpCtx block.  More code would have to go out of line.
<BR>
But that's the problem. 
<BR>
<P>Alternately, you could try
<BR>
<P>Index: mmu_context.h
<BR>
===================================================================
<BR>
RCS file: /home/rth/CVSROOT/linux/include/asm-alpha/mmu_context.h,v
<BR>
retrieving revision 1.7
<BR>
diff -u -p -r1.7 mmu_context.h
<BR>
--- mmu_context.h       1998/09/06 06:45:25     1.7
<BR>
+++ mmu_context.h       1998/12/18 16:51:25
<BR>
@@ -169,7 +169,9 @@ __reload_tss(struct thread_struct *tss)
<BR>
&nbsp;__EXTERN_INLINE void
<BR>
&nbsp;reload_context(struct task_struct *task)
<BR>
&nbsp;{
<BR>
+       int pcc = task-&gt;tss.pcc;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__reload_tss(&amp;task-&gt;tss);
<BR>
+       task-&gt;tss.pcc = pcc;
<BR>
&nbsp;}
<BR>
&nbsp;
<BR>
&nbsp;/*
<BR>
<P><P><P><P>r~
<BR>
<P><PRE>
-- 
To unsubscribe: send e-mail to <A HREF="mailto:axp-list-request@redhat.com?subject=Re:%20LX164%20and%20rpcc">axp-list-request@redhat.com</A> with
'unsubscribe' as the subject.  Do not send it to <A HREF="mailto:axp-list@redhat.com?subject=Re:%20LX164%20and%20rpcc">axp-list@redhat.com</A>
</PRE>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0812.html">Matt Wagner: "RE: SCSI Tape Drives"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0810.html">Chris Price: "Re: SCSI Tape Drives"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0802.html">Joachim Wesner: "Re: SCSI Tape Drives"</A>
<!-- nextthread="start" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.landfield.com/hypermail/">hypermail 2.0b3</A> 
on <EM>Fri Dec 18 1998 - 10:00:22 PST</EM>
</EM>
</SMALL>
</BODY>
</HTML>
