<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN"> 
     <HTML> 
     <HEAD> 
     <TITLE>Axp-List Archive</TITLE> 
     <LINK REV="made" HREF="mailto:mailto-address"> 
     <HEAD> 
     <BODY BGCOLOR="#DC9D33" TEXT="#000000" LINK="#DD0000" ALINK="#CC0000" VLINK="#CC0000">
		<CENTER>  <!--#exec cgi="/cgi-bin/banmat1.cgi"--></CENTER>

     <H1 ALIGN=CENTER>Axp-List Archive<BR> Re: Redhat 7.1 Alpha</H1> 
	
<!-- received="Sat Jun 23 22:38:45 2001" -->
<!-- isoreceived="20010624053845" -->
<!-- sent="Thu, 21 Jun 2001 12:37:15 -0400 (EDT)" -->
<!-- isosent="20010621163715" -->
<!-- name="Phillip Ezolt" -->
<!-- email="ezolt@perf.zko.dec.com" -->
<!-- subject="Re: Redhat 7.1 Alpha" -->
<!-- id="Pine.OSF.4.33.0106211228430.387881-100000@perf.zko.dec.com" -->
<!-- inreplyto="20010621112037.C20970@linux04.mro.cpqcorp.net" -->
<STRONG>Subject: </STRONG>Re: Redhat 7.1 Alpha<BR>
<STRONG>From: </STRONG>Phillip Ezolt (<EM>ezolt@perf.zko.dec.com</EM>)<BR>
<STRONG>Date: </STRONG>Thu Jun 21 09:37:15 2001
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.shtml#188">[ date ]</A>
<A HREF="index.shtml#188">[ thread ]</A>
<A HREF="subject.shtml#188">[ subject ]</A>
<A HREF="author.shtml#188">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0189.shtml">W Bauske: "Re: miata (PWS 433 au) memory spec ?"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0187.shtml">Christopher C. Chimelis: "Re: Problem Building 2.4.5-ac16"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0235.shtml">Jay Estabrook: "Re: Redhat 7.1 Alpha"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0230.shtml">Michal Jaegermann: "Re: Redhat 7.1 Alpha"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0235.shtml">Phillip Ezolt: "Re: Redhat 7.1 Alpha"</A>
<!-- reply="end" -->
</UL>
<HR>
<!-- body="start" -->
<P>
<EM>&gt; 4. Even text mode install appears broken on my UDB/Multia; somewhere during
</EM><BR>
<EM>&gt;    the initial part of the install, it starts &quot;anaconda&quot; and it never
</EM><BR>
<EM>&gt;    completes, running forever. This may possibly be a CDROM problem at
</EM><BR>
<EM>&gt;    my end; I'll have to attempt a network-based install to find out for
</EM><BR>
<EM>&gt;    sure.
</EM><BR>
<P>This is the result the following.  (See below.)
<BR>
<P>I suggest that redhat/Linus/Alan apply last patch to the kernel.
<BR>
<P>--Phil
<BR>
<P>Compaq:  High Performance Server Division/Benchmark Performance Engineering
<BR>
---------------- Alpha, The Fastest Processor on Earth --------------------
<BR>
Phillip.Ezolt@compaq.com        |C|O|M|P|A|Q|        ezolt@perf.zko.dec.com
<BR>
------------------- See the results at www.spec.org -----------------------
<BR>
<P>.....
<BR>
<P>This is the result of a buggy SRM, and unfortunately, it isn't fixed in the
<BR>
final digital SRM release for the UDB.
<BR>
<P>When entering the trap handler for an illegal instruction, the pc is not
<BR>
advanced properly. When the kernel hits a floating point error which is
<BR>
normally handled in the kernel, the pc never advances.
<BR>
<P>The problem is handled, but since the pc isn't advanced, the program rexecutes
<BR>
the same instruction, and BAM, trap.  This repeats infinitely.
<BR>
<P>Workaround:  Boot from MILO.  It has the Palcode fixed.
<BR>
<P>We hacked around the problem with the following code, but it is not in a state
<BR>
where it could be submitted to the kernel.
<BR>
<P>It needs some sort of dynamic check for broken SRM. (Maybe from the HWRPB? )
<BR>
<P>Even better would be fixed palcode....
<BR>
<P><P>diff -Nau arch/alpha/kernel/traps.c
<BR>
../linux-2.2.17-multia-kgdb/arch/alpha/kernel
<BR>
--- arch/alpha/kernel/traps.c   Fri Jan 12 04:31:34 2001
<BR>
+++ ../linux-2.2.17-multia-kgdb/arch/alpha/kernel/traps.c  Tue Dec 19
<BR>
18:19:02 2000
<BR>
@@ -449,6 +449,9 @@
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 4: /* opDEC */
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (implver() == IMPLVER_EV4) {
<BR>
+#if 1 /* alpha SRM */
<BR>
+                       regs.pc += 4;
<BR>
+#endif /* alpha SRM */
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* EV4 does not implement anything except normal
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rounding.  Everything else will come here as
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;an illegal instruction.  Emulate them.  */
<BR>
<P><P>------------------------------------------------------------------------
<BR>
Before he left, Bill Carr product the following patch.. It is more general
<BR>
than the one above:
<BR>
<P><P>--- linux-2.2.17-kgdb/arch/alpha/kernel/traps.c Mon Nov 13 11:22:33 2000
<BR>
+++ linux-2.2.17-multia-kgdb/arch/alpha/kernel/traps.c  Sun Mar 11 15:59:10
<BR>
2001
<BR>
@@ -115,6 +115,27 @@
<BR>
<P>&nbsp;static alist * int_name[] = {inta_name, intl_name, ints_name, intm_name};
<BR>
<P>+static int opDEC_test = 0;
<BR>
+static int opDEC_fix = 0;
<BR>
+static unsigned long opDEC_test_pc = 0;
<BR>
+
<BR>
+static void
<BR>
+opDEC_check(void)
<BR>
+{
<BR>
+       unsigned long test_pc;
<BR>
+       lock_kernel();
<BR>
+       opDEC_test = 1;
<BR>
+       __asm__ __volatile__(
<BR>
+       &quot;       br      %0,1f\n&quot;
<BR>
+       &quot;1:     addq    %0,8,%0\n&quot;
<BR>
+       &quot;       stq     %0,%1\n&quot;
<BR>
+       &quot;       cvttq/svm $f31,$f31\n&quot;
<BR>
+: &quot;=&amp;r&quot;(test_pc), &quot;=m&quot;(opDEC_test_pc)
<BR>
+: );
<BR>
+       opDEC_test = 0;
<BR>
+       unlock_kernel();
<BR>
+}
<BR>
+
<BR>
&nbsp;static char *
<BR>
&nbsp;assoc(int fcode, alist * a)
<BR>
&nbsp;{
<BR>
@@ -379,7 +400,9 @@
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* If we are dealing with a breakpoint or the debug hook isn't
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* installed, don't die. */
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((type != 0) ||(linux_debug_hook == (gdb_debug_hook *) NULL)) {
<BR>
-               die_if_kernel(&quot;Instruction fault&quot;, &amp;regs, type, 0);
<BR>
+               if (!opDEC_test || type != 4) {
<BR>
+                       die_if_kernel(&quot;Instruction fault&quot;, &amp;regs, type, 0);
<BR>
+               }
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
<BR>
&nbsp;#else
<BR>
&nbsp;asmlinkage void
<BR>
@@ -387,7 +410,9 @@
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long a2, unsigned long a3, unsigned long a4,
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned long a5, struct pt_regs regs)
<BR>
&nbsp;{
<BR>
-       die_if_kernel(&quot;Instruction fault&quot;, &amp;regs, type, 0);
<BR>
+       if (!opDEC_test || type != 4) {
<BR>
+               die_if_kernel(&quot;Instruction fault&quot;, &amp;regs, type, 0);
<BR>
+       }
<BR>
&nbsp;#endif
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (type) {
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 0: /* breakpoint */
<BR>
@@ -449,6 +474,25 @@
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 4: /* opDEC */
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (implver() == IMPLVER_EV4) {
<BR>
+                       /* We need to deal with the Multia (UDB) specially.
<BR>
+                          The last released SRM (V3.8) does not handle
<BR>
+                          the opDEC properly.  It returns the pc of the
<BR>
+                          opDEC fault, not the instruction after as the
<BR>
+                          Alpha architecture requires.  Here we fix it up.
<BR>
+                          We do this by intentionally causing an opDEC
<BR>
+                          fault during the boot sequence and testing if
<BR>
+                          we get the correct pc.  If not, we set a flag
<BR>
+                          to correct it every time through.
<BR>
+                       */
<BR>
+                       if (opDEC_test) {
<BR>
+                               if (regs.pc == opDEC_test_pc) {
<BR>
+                                       opDEC_fix = 1;
<BR>
+                               }
<BR>
+                       }
<BR>
+                       if (opDEC_fix) {
<BR>
+                               regs.pc += 4;
<BR>
+                       }
<BR>
+
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* EV4 does not implement anything except normal
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rounding.  Everything else will come here as
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;an illegal instruction.  Emulate them.  */
<BR>
@@ -1141,4 +1185,9 @@
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrent(entUna, 4);
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrent(entSys, 5);
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrent(entDbg, 6);
<BR>
+
<BR>
+       /* Hack for Multia (UDB)... the final released SRM has a bug in
<BR>
+          the handling of the opDEC fault.  Fix it up.
<BR>
+       */
<BR>
+       opDEC_check();
<BR>
&nbsp;}
<BR>
<P><P><P>_______________________________________________
<BR>
Axp-list mailing list
<BR>
Axp-list@redhat.com
<BR>
https://listman.redhat.com/mailman/listinfo/axp-list
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Next message:</STRONG> <A HREF="0189.shtml">W Bauske: "Re: miata (PWS 433 au) memory spec ?"</A>
<LI><STRONG>Previous message:</STRONG> <A HREF="0187.shtml">Christopher C. Chimelis: "Re: Problem Building 2.4.5-ac16"</A>
<LI><STRONG>In reply to:</STRONG> <A HREF="0235.shtml">Jay Estabrook: "Re: Redhat 7.1 Alpha"</A>
<!-- nextthread="start" -->
<LI><STRONG>Next in thread:</STRONG> <A HREF="0230.shtml">Michal Jaegermann: "Re: Redhat 7.1 Alpha"</A>
<LI><STRONG>Reply:</STRONG> <A HREF="0235.shtml">Phillip Ezolt: "Re: Redhat 7.1 Alpha"</A>
<!-- reply="end" -->
</UL>
<!-- trailer="footer" -->
<HR> 
     <P> 
     <SMALL> 
     <EM> 
     This archive was generated by  <A HREF="http://www.landfield.com/hypermail">hypermail version 2a22 </A> on Thu Jul  5 05:45:29 2001 PDT <BR>
	Send any problems or questions about this archive to <A HREF="mailto:webmaster@alphalinux.org">webmaster@alphalinux.org</A>. 
     </EM> 
     </SMALL> 
     </BODY> 
     </HTML> 
