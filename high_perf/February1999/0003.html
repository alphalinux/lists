<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>High Performance List: sqrt.c</TITLE>
<META NAME="Author" CONTENT="Robert Harley (Robert.Harley@inria.fr)">
<META NAME="Subject" CONTENT="sqrt.c">
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<H1 ALIGN=CENTER>sqrt.c</H1>
<HR>
<P>
<!-- received="Sun Feb 21 16:59:40 1999 PST" -->
<!-- sent="Sun, 21 Feb 1999 17:23:07 +0100 (MET)" -->
<!-- name="Robert Harley" -->
<!-- email="Robert.Harley@inria.fr" -->
<!-- subject="sqrt.c" -->
<!-- id="199902211623.RAA17291@pauillac.inria.fr" -->
<!-- inreplyto="" -->
<STRONG>Robert Harley</STRONG> (<A HREF="mailto:Robert.Harley@inria.fr?subject=Re:%20sqrt.c"><EM>Robert.Harley@inria.fr</EM></A>)<BR>
<EM>Sun, 21 Feb 1999 17:23:07 +0100 (MET)</EM>
<P>
<UL>
<LI><STRONG>Messages sorted by:</STRONG> 
<A HREF="date.html#3">[ date ]</A>
<A HREF="index.html#3">[ thread ]</A>
<A HREF="subject.html#3">[ subject ]</A>
<A HREF="author.html#3">[ author ]</A>
<!-- next="start" -->
<LI><STRONG>Previous message:</STRONG> <A HREF="0002.html">Robert Harley: "sqrt"</A>
<!-- nextthread="start" -->
</UL>
<HR>
<!-- body="start" -->
<P>
/* &gt; sqrt.c
<BR>
&nbsp;* Purpose: Fast double precision square root.
<BR>
&nbsp;* Copyright: (c) Robert J. Harley, 19-Oct-1998
<BR>
&nbsp;* Contact: <A HREF="mailto:Robert.Harley@inria.fr?subject=Re:%20sqrt.c">Robert.Harley@inria.fr</A>
<BR>
&nbsp;* Legalese: This code is subject to the GNU General Public License (v2).
<BR>
&nbsp;*/
<BR>
<P><P>/*-- sqrt ---------------------------------------------------------------*/
<BR>
<P>double sqrt(double a) {
<BR>
&nbsp;&nbsp;u64 ea, ua, ux, v, v2, w;
<BR>
&nbsp;&nbsp;s64 wm, wp;
<BR>
&nbsp;&nbsp;double b, t, x, z;
<BR>
&nbsp;&nbsp;union { double d; u64 u; } du;
<BR>
&nbsp;&nbsp;const double
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;sqrt2o2 = 0.70710678118654757273731092936941422522068023681640625
<BR>
&nbsp;&nbsp;;
<BR>
&nbsp;&nbsp;static const unsigned char tab[64] =
<BR>
&nbsp;&nbsp;{ 127, 125, 123, 121, 119, 118, 116, 114, 113, 111, 109, 108, 106
<BR>
&nbsp;&nbsp;, 105, 103, 102, 100, 99, 97, 96, 95, 93, 92, 91, 90, 88, 87, 86, 85
<BR>
&nbsp;&nbsp;, 84, 83, 82, 80, 79, 78, 77, 76, 75, 74, 73, 72, 71, 70, 70, 69, 68
<BR>
&nbsp;&nbsp;, 67, 66, 65, 64, 63, 63, 62, 61, 60, 59, 59, 58, 57, 56, 56, 55, 54, 53
<BR>
&nbsp;&nbsp;};
<BR>
<P><P>&nbsp;&nbsp;/** Initial approximation to 1/sqrt(b) from table. **/
<BR>
<P>&nbsp;&nbsp;du.d = a; ua = du.u;
<BR>
<P>&nbsp;&nbsp;du.u = (u64)tab[ua&gt;&gt;46 &amp; 63UL]&lt;&lt;45 | 1022UL&lt;&lt;52; x = du.d;
<BR>
<P>&nbsp;&nbsp;/* Nuke sign &amp; exponent. */
<BR>
&nbsp;&nbsp;du.u = ua&lt;&lt;12&gt;&gt;12 | 1022UL&lt;&lt;52; z = du.d;
<BR>
<P><P>&nbsp;&nbsp;/** Go out-of-line in rare cases (could do it earlier but faster here). **/
<BR>
<P>&nbsp;&nbsp;if ((s64)ua &lt;= 0L) goto pm_zero_or_negative;
<BR>
&nbsp;&nbsp;ea = ua&gt;&gt;52;
<BR>
&nbsp;&nbsp;if (!ea) goto positive_denormal;
<BR>
&nbsp;&nbsp;if (ea == 2047UL) goto pos_nan_or_inf;
<BR>
<P><P>&nbsp;&nbsp;/** Improve approximation to 1/sqrt(b) with Newton iterations. **/
<BR>
<P>&nbsp;&nbsp;b = z+z;
<BR>
&nbsp;&nbsp;z *= x*x; t = 1.5-z; z *= t*t; x *= t; t = 1.5-z; x *= t;
<BR>
<P>&nbsp;&nbsp;/* Handle exponent parity. */
<BR>
&nbsp;&nbsp;w = ua&lt;&lt;52;
<BR>
&nbsp;&nbsp;if (!(ea &amp; 1UL)) { b += b; x *= sqrt2o2; w = ua&lt;&lt;53; }
<BR>
<P><P>&nbsp;&nbsp;/** Final Newton iteration and multiply by b to get sqrt(b).. **/
<BR>
<P>&nbsp;&nbsp;t = b*x; x = t+0.5*x*(b-t*t);
<BR>
<P><P>&nbsp;&nbsp;/* Magic incantation to fix last bit. */
<BR>
<P>&nbsp;&nbsp;du.d = x; ux = du.u;
<BR>
&nbsp;&nbsp;v = ux-(1022UL&lt;&lt;52); v2 = v*v;
<BR>
&nbsp;&nbsp;ux += (((ea+1UL)&gt;&gt;1)-512UL)&lt;&lt;52; /* Insert exponent of result. */
<BR>
&nbsp;&nbsp;wp = (s64)(w+v); wm = (s64)(w-v);
<BR>
<P>&nbsp;&nbsp;{ union { double d; u64 u; } dut[3];
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;dut[0].u = ux+1UL;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;dut[1].u = ux;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;dut[2].u = ux-1UL;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;wp = (s64)v2-wp &gt;= 0L;
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;wm = ((s64)v2-wm)&gt;&gt;63;
<BR>
<P>&nbsp;&nbsp;&nbsp;&nbsp;x = dut[1L+wp+wm].d;
<BR>
&nbsp;&nbsp;} /* end block */
<BR>
<P>&nbsp;&nbsp;return x;
<BR>
<P>&nbsp;&nbsp;/* Junk for now. TO DO: put code for these cases in. */
<BR>
pm_zero_or_negative:
<BR>
positive_denormal:
<BR>
pos_nan_or_inf:
<BR>
<P>&nbsp;&nbsp;return 0.0;
<BR>
<P>} /* end sqrt */
<BR>
<P><!-- body="end" -->
<HR>
<P>
<UL>
<!-- next="start" -->
<LI><STRONG>Previous message:</STRONG> <A HREF="0002.html">Robert Harley: "sqrt"</A>
<!-- nextthread="start" -->
</UL>
<!-- trailer="footer" -->
<HR>
<P>
<SMALL>
<EM>
This archive was generated by <A HREF="http://www.landfield.com/hypermail/">hypermail 2.0b3</A> 
on <EM>Sun Feb 21 1999 - 09:00:26 PST</EM>
</EM>
</SMALL>
</BODY>
</HTML>
